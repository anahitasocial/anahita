/*! anahita 31-08-2020 */

!function(a,o,e){"use strict";if(a.widget("anahita.locations",{options:{modal:"#an-modal",formContainer:"#location-form-container",loationsSelector:'[data-trigger*="LocationSelector"]',locationsContainer:"#locations-container",searchQuery:"#an-search-query",entities:".an-entities",entity:".an-entity",locationsList:".an-locations"},_create:function(){var i=this;this.modal=a(this.options.modal),this.formContainer=null,this.locationsContainer=null,this.currentList=null,this.locatableId=null,this.browser_coords=null,this._on(a(e),{geoposition:function(o){a(i.options.loationsSelector).prop("disabled",!1)}}),this._on(this.options.loationsSelector,{click:function(o){o.preventDefault(),i.locatableId=a(o.currentTarget).data("locatable"),i.showSelector(o.currentTarget)}}),a(this.options.locationsList).each(function(o,t){a(t).load(a(t).data("url"))}),this._on(this.element,{afterFilterbox:function(o){0==i.locationsContainer.find(this.options.entity).length&&i.showForm()},beforeFilterbox:function(o){var t=i.locationsContainer.find(i.options.entities),n=a(i.options.locationsContainer).find("form");""==a(i.options.searchQuery).val()?n.attr("action",t.data("url")+"&"+i.browser_coords):n.attr("action",t.data("url"))}})},showSelector:function(o){var t=this;this.modal.find(".modal-footer").hide();var n=this.modal.find(".modal-header").find("h3"),i=this.modal.find(".modal-body");a.get(a(o).data("url"),function(o){n.html(a(o).filter(".modal-header").html()),i.html(a(o).filter(".modal-body").html()),t.modal.modal("show"),t.formContainer=a(t.options.formContainer),t.locationsContainer=a(t.options.locationsContainer),t.searchQuery=a(t.options.searchQuery),t.formContainer.hide(),t.browse()})},browse:function(){var n=this,i=this.locationsContainer.find(this.options.entities),o=i.data("url");if(a(e).data("browser_coords")){var t=a(e).data("browser_coords");this.browser_coords=a.param({nearby_latitude:t.latitude,nearby_longitude:t.longitude})}a.ajax({method:"GET",url:o+"&"+n.browser_coords,success:function(o){var t=a(o).filter(n.options.entity);t.length?(n.hideForm(),a(i).html(t)):n.showForm()}})},add:function(){var t=this,n=t.formContainer.find("form");a.ajax({method:"POST",url:n.attr("action"),data:n.serialize(),beforeSend:function(){n.find(":submit").button("loading")},success:function(o){t.refresh(),t.modal.modal("hide")},complete:function(o,t){n.find(":submit").button("reset")}})},showForm:function(){this.formContainer.show(),this.locationsContainer.hide();var o=this.formContainer.find("form");this.searchQuery.val()&&a(o).find('input[name="name"]').val(this.searchQuery.val())},hideForm:function(){this.formContainer.hide(),this.locationsContainer.show()},addLocation:function(o){var t=this,n=a(o);a.ajax({method:"POST",url:n.attr("href"),data:{action:"addlocation",location_id:n.data("location")},success:function(o){t.modal.modal("hide"),t.refresh()}})},deleteLocation:function(o){var t=a(o);a.ajax({method:"POST",url:t.attr("href"),data:{action:"deletelocation",location_id:t.data("location")},success:function(o){t.closest("li").fadeOut()}})},refresh:function(){var t=a("#locations-"+this.locatableId);a.ajax({method:"GET",url:t.data("url"),success:function(o){t.html(o)}})}}),a(".an-locations").length){var t=a("body").locations();a("body").on("click",'a[data-action="add-location"]',function(o){o.preventDefault(),t.locations("addLocation",this)}),a("body").on("click",'a[data-action="delete-location"]',function(o){o.preventDefault(),t.locations("deleteLocation",this)}),a("body").on("submit","#location-form-container form",function(o){o.preventDefault(),t.locations("add",this)}),a("body").on("click",'a[data-trigger="FormSelector"]',function(o){o.preventDefault(),t.locations("hideForm",this)})}}(jQuery,window,document);